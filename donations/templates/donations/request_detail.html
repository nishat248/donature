{% extends "donations/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'donations/css/request_detail.css' %}">

<div class="detail-container">
    <div class="detail-card {{ req.urgency }}">
        {% if req.image %}
            <img src="{{ req.image.url }}" alt="{{ req.title }}" class="detail-img">
        {% endif %}

        <div class="detail-info">
            <h2>{{ req.title }}</h2>
            <p><strong>Category:</strong> {{ req.category }}</p>
            <p><strong>Quantity:</strong> {{ req.quantity }}</p>
            <p><strong>Description:</strong> {{ req.description }}</p>
            <p><strong>Needed Before:</strong> {% if req.needed_before %}{{ req.needed_before }}{% else %}Not specified{% endif %}</p>
            <p><strong>Delivery Location:</strong> {{ req.delivery_location }}</p>
            <p><strong>Contact:</strong> {{ req.contact_number }}</p>
            <p><strong>Urgency:</strong> {{ req.get_urgency_display }}</p>
            <p><strong>Status:</strong> {{ req.get_status_display }}</p>
        </div>
    </div>

    <div class="detail-actions">
    {% if request.user == req.requester %}
        <a href="{% url 'edit_request' req.id %}" class="btn btn-edit">Edit</a>
        <a href="{% url 'delete_request' req.id %}" class="btn btn-delete"
           onclick="return confirm('Are you sure you want to delete this request?');">Delete</a>
    {% else %}
        {% if request.user.is_authenticated %}
            {% if donor_has_donated %}
                <a href="#" class="btn btn-info">You donated to this request</a>
            {% else %}
                <a href="{% url 'donate_item_to_request' req.id %}" class="btn btn-donate">Donate</a>
            {% endif %}
        {% else %}
            <!-- Guest user -->
            <a href="#" class="btn btn-donate" onclick="openModal('loginModal')">Donate</a>
        {% endif %}
    {% endif %}
    <a href="{% url 'donate_to_requests' %}" class="btn btn-back">Back</a>
</div>


    <div class="donations-list-section">
        <h3>Donation History</h3>
        {% if has_donations %}
            <div class="donations-cards">
                {% for donation in req.donations.all %}
                <div class="donation-card">
                    <div class="donation-img">
                        {% if donation.image %}
                            <img src="{{ donation.image.url }}" alt="{{ donation.title }}">
                        {% else %}
                            <img src="{% static 'images/default-donation.jpg' %}" alt="Donation">
                        {% endif %}
                    </div>
                    <div class="donation-info">
                        <p><strong>Donor:</strong> {{ donation.donor.username }}</p>
                        <p><strong>Title:</strong> {{ donation.title }}</p>
                        <p><strong>Description:</strong> {{ donation.description|truncatewords:25 }}</p>
                        <p><strong>Quantity:</strong> {{ donation.quantity }}</p>
                        <p><strong>Status:</strong> {{ donation.get_status_display }}</p>
                        {% if request.user == req.requester and donation.status == 'pending' %}
                            <form action="{% url 'mark_received' donation.id %}" method="POST" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-receive">Mark as Received</button>
                            </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p>No donations yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
