{% extends "donations/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'ngos/css/explore_campaigns.css' %}">

<div class="browse-container">
    <div class="browse-header">
        <h1><i class="fas fa-hand-holding-heart"></i> Ongoing NGO Campaigns</h1>
        <p>Support campaigns and make a difference</p>
    </div>

    <div class="browse-content">

        <!-- Filters Sidebar -->
        <div class="filters-sidebar">
            <!-- Search Box -->
            <div class="filter-section">
                <h3>Search Campaigns</h3>
                <form method="GET" action="{% url 'explore_campaigns' %}">
                    <div class="search-box">
                        <input type="text" name="q" placeholder="Search campaigns..." value="{{ search_query|default:'' }}">
                        <button type="submit" class="search-btn"><i class="fas fa-search"></i></button>
                    </div>
                </form>
            </div>

            <!-- Filters -->
            <div class="filter-section">
                <h3>Filters</h3>
                <form method="GET" action="{% url 'explore_campaigns' %}" id="filter-form">

                    <!-- Category -->
                    <div class="filter-group">
                        <h4>Category</h4>
                        <select name="category" class="filter-select">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}"
                                {% if selected_category|default:'' == category.id|stringformat:"s" %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Location -->
                    <div class="filter-group">
                        <h4>Location</h4>
                        <select name="location" class="filter-select">
                            <option value="">All Locations</option>
                            {% for location in locations %}
                            <option value="{{ location }}"
                                {% if selected_location|default:'' == location %}selected{% endif %}>
                                {{ location }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- NGO -->
                    <div class="filter-group">
                        <h4>NGO</h4>
                        <select name="ngo" class="filter-select">
                            <option value="">All NGOs</option>
                            {% for ngo in ngos %}
                            <option value="{{ ngo.user.id }}"
                                {% if selected_ngo|default:'' == ngo.user.id|stringformat:"s" %}selected{% endif %}>
                                {{ ngo.ngo_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-actions">
                        <button type="submit" class="apply-filters-btn">Apply Filters</button>
                        <a href="{% url 'explore_campaigns' %}" class="reset-filters-btn">Reset</a>
                    </div>

                </form>
            </div>
        </div>

        <!-- Campaigns Listing -->
        <div class="donations-list-wrapper">
            {% if campaigns %}
            <div class="donations-list">
                {% for campaign in campaigns %}
                <div class="donation-card campaign-card">
                    <div class="card-image">
                        {% if campaign.image %}
                        <img src="{{ campaign.image.url }}" alt="{{ campaign.title }}">
                        {% else %}
                        <img src="{% static 'images/default-campaign.jpg' %}" alt="{{ campaign.title }}">
                        {% endif %}
                    </div>

                    <div class="card-content">
                        <h3>{{ campaign.title }}</h3>
                        <p class="by-ngo">
                            by {% if campaign.ngo.ngoprofile %}{{ campaign.ngo.ngoprofile.ngo_name }}{% else %}{{ campaign.ngo.username }}{% endif %}
                        </p>
                        <p class="campaign-desc">{{ campaign.description|truncatewords:20 }}</p>

                        <!-- Progress Bar -->
                        <div class="campaign-stats">
                            <div class="progress-bar">
                                <div class="progress" data-percent="{{ campaign.progress_percent|default:0 }}"></div>
                            </div>
                            <div class="stats">
                                <span><strong>Raised:</strong> ৳{{ campaign.collected_amount|default:0 }}</span>
                                <span><strong>Goal:</strong> ৳{{ campaign.goal_amount|default:0 }}</span>
                                <span><strong>Donors:</strong> {{ campaign.donors_count|default:0 }}</span>
                            </div>
                        </div>

                        <div class="card-actions">
                            <a href="{% url 'campaign_detail' campaign.id %}" class="btn-details">See Details</a>
                            {% if user.is_authenticated %}
                                <a href="{% url 'donate_to_campaign' campaign.id %}" class="btn-claim">Donate</a>
                            {% else %}
                                <a href="#" class="btn-claim" onclick="openModal('loginModal')">Login to Donate</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination with filter preservation -->
            {% if campaigns.has_other_pages %}
            <div class="pagination">
                {% if campaigns.has_previous %}
                <a href="?page={{ campaigns.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}" class="page-btn">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
                {% endif %}

                {% for num in campaigns.paginator.page_range %}
                    {% if campaigns.number == num %}
                    <span class="page-btn active">{{ num }}</span>
                    {% else %}
                    <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}" class="page-btn">{{ num }}</a>
                    {% endif %}
                {% endfor %}

                {% if campaigns.has_next %}
                <a href="?page={{ campaigns.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}" class="page-btn">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
                {% endif %}
            </div>
            {% endif %}

            {% else %}
            <div class="no-results">
                <i class="fas fa-search fa-3x"></i>
                <h3>No campaigns found</h3>
                <p>Try adjusting your filters or check back later for new campaigns.</p>
            </div>
            {% endif %}
        </div>

    </div>
</div>

<!-- JS for Progress Bars + Filters -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animate progress bars
    document.querySelectorAll('.progress').forEach(bar => {
        const percent = parseFloat(bar.dataset.percent) || 0;
        bar.style.width = percent + '%';
        bar.style.transition = 'width 0.6s ease';
    });

    // Filters auto-submit
    const filterForm = document.getElementById('filter-form');
    if(filterForm) {
        filterForm.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', () => filterForm.submit());
        });
    }
});
</script>

{% endblock %}
